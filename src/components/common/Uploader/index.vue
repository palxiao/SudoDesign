<!--
 * @Author: ShawnPhang
 * @Date: 2021-08-29 18:17:13
 * @Description: 二次封装上传组件
 * @LastEditors: ShawnPhang
 * @LastEditTime: 2022-02-24 00:19:41
 * @site: book.palxp.com / blog.palxp.com
-->
<template>
  <el-upload action="" :http-request="upload" :show-file-list="false" multiple>
    <slot>
      <el-button size="mini">上传图片<i class="el-icon-upload el-icon--right"></i></el-button>
    </slot>
  </el-upload>
</template>

<script lang="ts">
import { defineComponent } from 'vue'
import { ElUpload } from 'element-plus'
import Qiniu from '@/common/methods/QiNiu'
import { getImage } from '@/common/methods/getImgDetail'
import _config from '@/config'

export default defineComponent({
  components: { ElUpload },
  props: {
    modelValue: {},
    options: {
      default: () => {
        return { bucket: 'cloud-design', prePath: 'user' }
      },
    },
  },
  emits: ['done', 'update:modelValue'],
  setup(props, context) {
    let uploading: boolean = false // 上传状态Flag
    let timer: any = null

    let uploadList: any[] = [] // 上传队列
    let index: number = 0 // 当前上传的脚标
    let count: number = 0 // 当前上传总数

    let tempSimpleRes: any = null // 单个文件上传时返回

    const upload = ({ file }: any) => {
      uploadList.push(file)
      clearTimeout(timer)
      count++
      updatePercent(null)
      uploadQueue()
    }
    // 上传队列
    const uploadQueue = async () => {
      if (!uploading) {
        uploading = true
        if (uploadList[0]) {
          tempSimpleRes = await qiNiuUpload(uploadList[0]) // 队列有文件，执行上传
          const { width, height }: any = await getImage(uploadList[0])
          context.emit('done', { width, height, url: _config.IMG_URL + tempSimpleRes.key }) // 单个文件进行响应
          uploading = false
          handleRemove() // 移除已上传文件
          index++
          updatePercent(null)
          uploadQueue()
        } else {
          uploading = false
          timer = setTimeout(() => {
            index = count = 0
            updatePercent(0)
          }, 3000)
        }
      }
    }
    const qiNiuUpload = async (file: File) => {
      updatePercent(0)
      return new Promise(async (resolve: Function) => {
        const result: any = await Qiniu.upload(file, props.options, (res: Type.Object) => {
          updatePercent(res.total.percent)
        })
        resolve(result)
      })
    }
    // 更新视图
    const updatePercent = (p?: number | null) => {
      const num = typeof p === 'number' ? String(p) : p
      const percent = { ...props.modelValue }
      percent.num = num ? Number(num).toFixed(0) : percent.num
      percent.ratio = count ? `${index} / ${count}` : ''
      context.emit('update:modelValue', percent)
    }
    const handleRemove = () => {
      if (uploadList.length <= 0) {
        return
      }
      uploadList.splice(0, 1)
    }

    return {
      upload,
    }
  },
})
</script>

<style lang="less" scoped>
:deep(.el-upload) {
  display: inherit;
}
</style>